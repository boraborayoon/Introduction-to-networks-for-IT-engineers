# 6.1 4계층 장비의 특징
- 세션 장비: 4계층 이상에서 동작하는 로드밸런서, 봥화벽과 같은 장비
    - 세션 테이블
        - 일반적인 2,3계층 네트워크 장비와 달리 세션을 이해하고 세션 테이블 유지
        - 패킷을 변경하거나 애플리케이션 성능을 최적화 하고 보안을 강화하기 위해 패킷을 Forward하거나 Drop
    - Symmetric(대칭) 경로 요구
    - 정보 변경(로드밸런서의 경우)

# 6.2 로드 밸런서
- 서버나 장비의 부하를 분산하기 위해 사용하는 장비
## 1. L4 로드 밸런싱
- TCP, UDP 정보 (특히 포트 넘버)를 기반으로 로드 밸런싱 수행
- 4계층에 대한 정보로만 분산 처리 하는 경우
## 2. L7 로드 밸런싱
- HTTP, FTP, SMTP와 같은 애플리케이션 프로토콜 정보를 기반으로 로드 밸런싱 수행
- HTTP 헤더 정보나 URI와 같은 정보를 기반으로 프로토콜을 이해한 후 부하를 분산 -> ADC(Application Delivery Controller)라고 부르며 프록시(proxy)역할을 수행
- ADC는 4계층에서 애플리케이션 계층까지 로드 밸런싱 기능을 제공하고 failover, redirection 기능도 함께 수행
- ACD의 캐싱(Caching)기능으로 성능 최적화

# 6.3 방화벽
- 네트워크 중간에 위치해 해당 장비를 통과하는 트래픽을 사전에 주어진 정책 조건에 맞추어 허용하거나 차단하는 장비
- NAT(Network Address Translation) 동작 방식과 유사하게 세션 정보를 장비 내부에 저장

# 6.4 4계층 장비를 통과할 때의 유의점 (세션 관리)
## 6.4.1 세션 테이블 유지, 세션 정보 동기화
### 6.4.1.1 세션 장비 운영자 입장
#### 1. 세션 만료 시간 증가
- 세션 장비 운영자가 애플리케이션에 맞게 세션 만료 시간을 늘림: 애플리케이션의 세션 유지 시간 < 방화벽 세션 유지 시간
#### 2. 세션 시간을 둔 채로 중간 패킷을 수용할 수 있도록 방화벽 설정 (세션 장비 중 방화벽에 해당)
- 예를들어 세션 테이블에 정보가 없는 ACK 패킷이 들어오더라도 세션을 새로 만들어 통과시키는 옵션 -> 보안이 취약해질 수 있어 비추천
#### 3. 세션 장비에서 세션 타임아웃 시 양 단말에 세션 종료 통보
- 세션 타임아웃 시 세션 정보에 있는 양 종단 장비에 세션 정보 만료(RST)를 통보

### 6.4.1.2 개발자 입장
#### 1. 애플리케이션에서 주기적인 패킷 발생 기능 추가
- 애플리케이션 개발 시 중간에 통신이 없더라도 일정 시간마다 양 단말 애플리케이션의 세션 상태 정보를 체크하는 Dummy Packet을 보내는 기능을 추가하면 패킷이 주기적으로 발생해 중간 방화벽에서 세션 타임아웃이 발생하기 전에 세션을 유지할 수 있다.
- 가장 바람직한 방법

## 6.4.2 비대칭 경로 문제
- 대칭 경로(Symmetric Path): 인바운드 패킷과 아웃바운드 패킷이 같은 장비를 통과하는 것
- 비대칭 경로(Asymmetric Path): 인바운드 패킷과 아웃바둔드 패킷이 다른 장비를 통과하는 것
- 가장 좋은 해결 방법은 비대칭 경로가 생기지 않도록 네트워크 경로를 디자인 하는 것
- 처리 방법
    1. 세션 테이블 동기화
    - 하지만 세션을 동기화하는 시간보다 패킷 응답이 빠르면 정상적으로 동작하지 않을 수 있는 단점이 있어 비추천
    - 이 기능은 응답시간이 비교적 긴 인터넷 게이트웨이로 방화벽이 사용될 때 유용하게 사용
    2. 비대칭 경로 발생 시, 세션 장비에서 보정
    - 인바운드 패킷이 통과하지 않았는데 아웃바운드 패킷이 장비로 들어온 경우, 인바운드 패킷이 통과한 다른 세션 장비 쪽으로 패킷을 보내 경로를 보정 -> 강제로 대칭경로를 만들어 줌: 이때 방화벽 간 통신용 링크가 필요하고 MAC 주소를 변경하는 MAC Rewriting 이나 기존 패킷에 MAC 주소를 한번 더 인캡슐레이션하는 Tunneling기법으로 경로를 보정

## 6.4.3 하나의 통신에 두 개 이상의 세션이 사용될 때의 고려사항
- 대부분 하나의 통신을 위해 한 개의 세션만 사용하지만, 특별한 목적으로 두 개 이상의 세션을 만드는 경우도 있다.
- 프로토콜은 데이터 프로토콜(데이터 전송용)과 컨트롤 프로토콜(데이터가 잘 전송되도록 세션을 제어)로 구분 -> 대표적으로 FTP(File Transfer Protocol)